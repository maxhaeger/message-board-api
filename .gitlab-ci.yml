default:
  image:
    name: alpine/k8s:1.25.16

stages:
  - setup
  - deploy
  - post-deploy

setup:
  image:
    name: hashicorp/terraform:latest
  stage: setup
  script:
    - cd terraform
    - terraform init
    - terraform apply -auto-approve
  variables:
    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
    TF_VAR_linode_token: $TF_VAR_linode_token

deploy:
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  before_script:
    - apk add --no-cache bash # Add Bash to the image
  script:
    - set -x # Enable debugging
    - cd ./terraform
    - bash import-kubeconfig.sh
    - sleep 5
    - cd ../helm
    - helm install backend ./backend
    - helm install frontend ./frontend
    - helm install environment ./environment
  after_script:
    - sleep 60

post-deploy:
  stage: post-deploy
  script:
    - kubectl apply -f https://bit.ly/ingress_nginx_1_2_0
    - kubectl get svc -l app.kubernetes.io/name=ingress-nginx -o jsonpath='{.items[0].status.loadBalancer.ingress[0].ip}'
